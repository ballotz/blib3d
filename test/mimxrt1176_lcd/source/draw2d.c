#include "draw2d.h"

void draw2d_fill_16(draw2d_rect_type* rect, uint16_t color)
{
    uint16_t* prow, * p;
    int y, x;

    prow = rect->data;
    for (y = 0; y < rect->height; ++y)
    {
        p = prow;
        for (x = 0; x < rect->width; ++x)
            *p++ = color;
        prow += rect->stride;
    }
}

void draw2d_fill_32(draw2d_rect_type* rect, uint32_t color)
{
    uint32_t* prow, * p;
    int y, x;

    prow = rect->data;
    for (y = 0; y < rect->height; ++y)
    {
        p = prow;
        for (x = 0; x < rect->width; ++x)
            *p++ = color;
        prow += rect->stride;
    }
}

static inline int32_t draw2d_clip(int32_t v, int32_t lim)
{
    if (v < 0)
        return 0;
    if (v > lim)
        return lim;
    return v;
}

//[[gnu::section(".data.$BOARD_SDRAM")]]
const uint8_t draw2d_font_data[1536] =
{
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC3,
    0xFF, 0xC3, 0xFF, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x83,
    0xFF, 0xFF, 0x87, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x9F, 0xF9, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0xFF, 0xFF, 0xE7, 0xFF, 0xFF, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0xFF, 0xFF, 0xFF, 0xF3, 0xCF, 0xFF, 0xFF,
    0xE7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xE7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xF9, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xCF,
    0xFF, 0xF3, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF9,
    0xFF, 0xFF, 0xF3, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x9F, 0xF9, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0xFF, 0xF3, 0xE7, 0xCF, 0xFF, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0xF1, 0xFF, 0xFF, 0xE7, 0xE7, 0xFF, 0xFF,
    0xF3, 0xFF, 0xFF, 0x9F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xF3, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xF3, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xCF,
    0xF9, 0xF3, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF9,
    0xFF, 0xFF, 0xF3, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x9F, 0xF9, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF3, 0xFF, 0xE7, 0xE7, 0xE7, 0xFF, 0x00,
    0xFF, 0xE7, 0xFF, 0xC9, 0xC3, 0xE4, 0xC4, 0xFF, 0xE7, 0xE7, 0xFF, 0xFF,
    0xE3, 0xFF, 0xE3, 0x9F, 0xE1, 0xF3, 0x81, 0xC3, 0xF9, 0x87, 0xC3, 0xCF,
    0xC3, 0xC7, 0xE3, 0xE3, 0xF9, 0xFF, 0x9F, 0xE7, 0x80, 0x99, 0x83, 0xC3,
    0x87, 0x81, 0x9F, 0xC1, 0x99, 0xC3, 0xC3, 0x99, 0x81, 0x9C, 0x9C, 0xC3,
    0x9F, 0xC3, 0x99, 0xC3, 0xE7, 0xC3, 0xE7, 0xC9, 0x99, 0xE7, 0x81, 0xCF,
    0xF9, 0xF3, 0xFF, 0xFF, 0xFF, 0xC1, 0x83, 0xC3, 0xC1, 0xC3, 0xCF, 0xC1,
    0x99, 0x81, 0xF3, 0x99, 0x81, 0x9C, 0x99, 0xC3, 0x83, 0xC1, 0x9F, 0x83,
    0xE1, 0xC1, 0xE7, 0xC9, 0x99, 0xC3, 0x81, 0xE7, 0xE7, 0xE7, 0xFF, 0x00,
    0xFF, 0xE7, 0xFF, 0xC9, 0x99, 0xA4, 0x99, 0xFF, 0xCF, 0xF3, 0xFF, 0xFF,
    0xE3, 0xFF, 0xE3, 0xCF, 0xCC, 0xF3, 0x9F, 0x99, 0xF9, 0xF3, 0x99, 0xCF,
    0x99, 0xE7, 0xE3, 0xE3, 0xF3, 0xFF, 0xCF, 0xE7, 0x3F, 0x99, 0x99, 0x99,
    0x93, 0x9F, 0x9F, 0x99, 0x99, 0xE7, 0x99, 0x99, 0x9F, 0x9C, 0x9C, 0x99,
    0x9F, 0x99, 0x99, 0x99, 0xE7, 0x99, 0xC3, 0xC9, 0x99, 0xE7, 0x9F, 0xCF,
    0xF3, 0xF3, 0xFF, 0xFF, 0xFF, 0x99, 0x99, 0x99, 0x99, 0x9F, 0xCF, 0x99,
    0x99, 0xE7, 0xF3, 0x99, 0xE7, 0x94, 0x99, 0x99, 0x99, 0x99, 0x9F, 0xF9,
    0xCF, 0x99, 0xC3, 0xC9, 0x99, 0x99, 0x9F, 0xE7, 0xE7, 0xE7, 0xFF, 0x00,
    0xFF, 0xFF, 0xFF, 0x80, 0xF9, 0x91, 0x99, 0xFF, 0xCF, 0xF3, 0xC9, 0xE7,
    0xFF, 0xFF, 0xFF, 0xCF, 0xC4, 0xF3, 0xCF, 0x99, 0x80, 0xF9, 0x99, 0xCF,
    0x99, 0xF3, 0xFF, 0xFF, 0xE7, 0xFF, 0xE7, 0xFF, 0x30, 0x99, 0x99, 0x99,
    0x99, 0x9F, 0x9F, 0x99, 0x99, 0xE7, 0x99, 0x93, 0x9F, 0x9C, 0x9C, 0x99,
    0x9F, 0x99, 0x99, 0xF9, 0xE7, 0x99, 0x99, 0xC9, 0x99, 0xE7, 0x9F, 0xCF,
    0xF3, 0xF3, 0xFF, 0xFF, 0xFF, 0x99, 0x99, 0x9F, 0x99, 0x9F, 0xCF, 0x99,
    0x99, 0xE7, 0xF3, 0x93, 0xE7, 0x94, 0x99, 0x99, 0x99, 0x99, 0x9F, 0xF9,
    0xCF, 0x99, 0x99, 0x94, 0xC3, 0x99, 0xCF, 0xCF, 0xE7, 0xF3, 0xFF, 0x00,
    0xFF, 0xE7, 0xFF, 0xC9, 0xF3, 0xCF, 0x90, 0xFF, 0xCF, 0xF3, 0xE3, 0xE7,
    0xFF, 0xFF, 0xFF, 0xE7, 0xC4, 0xF3, 0xE7, 0xF9, 0x99, 0xF9, 0x99, 0xE7,
    0x91, 0xC1, 0xFF, 0xFF, 0xCF, 0x81, 0xF3, 0xE7, 0x24, 0x81, 0x99, 0x9F,
    0x99, 0x9F, 0x9F, 0x91, 0x99, 0xE7, 0xF9, 0x93, 0x9F, 0x94, 0x98, 0x99,
    0x9F, 0x99, 0x93, 0xF3, 0xE7, 0x99, 0x99, 0x94, 0xD3, 0xE7, 0xCF, 0xCF,
    0xE7, 0xF3, 0xFF, 0xFF, 0xFF, 0xC1, 0x99, 0x9F, 0x99, 0x81, 0xCF, 0x99,
    0x99, 0xE7, 0xF3, 0x87, 0xE7, 0x94, 0x99, 0x99, 0x99, 0x99, 0x9F, 0xC3,
    0xCF, 0x99, 0x99, 0x94, 0xE7, 0x99, 0xE7, 0x9F, 0xE7, 0xF9, 0xFF, 0x00,
    0xFF, 0xE7, 0xFF, 0xC9, 0xE7, 0xE7, 0x9F, 0xFF, 0xCF, 0xF3, 0x80, 0x81,
    0xFF, 0x81, 0xFF, 0xE7, 0xCC, 0xF3, 0xF3, 0xE3, 0xC9, 0x83, 0x99, 0xE7,
    0xC3, 0x99, 0xFF, 0xFF, 0x9F, 0xFF, 0xF9, 0xE7, 0x24, 0x99, 0x83, 0x9F,
    0x99, 0x83, 0x83, 0x9F, 0x81, 0xE7, 0xF9, 0x87, 0x9F, 0x94, 0x90, 0x99,
    0x83, 0x99, 0x83, 0xE7, 0xE7, 0x99, 0x99, 0x94, 0xE7, 0xC3, 0xE7, 0xCF,
    0xE7, 0xF3, 0xFF, 0xFF, 0xFF, 0xF9, 0x99, 0x9F, 0x99, 0x99, 0x81, 0x99,
    0x99, 0xE7, 0xF3, 0x93, 0xE7, 0x94, 0x99, 0x99, 0x99, 0x99, 0x8F, 0x9F,
    0xCF, 0x99, 0x99, 0x94, 0xC3, 0x99, 0xF3, 0xCF, 0xE7, 0xF3, 0xFF, 0x00,
    0xFF, 0xC3, 0xFF, 0xC9, 0xCF, 0xF3, 0xC7, 0xFF, 0xCF, 0xF3, 0xE3, 0xE7,
    0xFF, 0xFF, 0xFF, 0xF3, 0xC8, 0xF3, 0xF9, 0xF9, 0xC9, 0x9F, 0x83, 0xF3,
    0x89, 0x99, 0xE3, 0xE3, 0xCF, 0x81, 0xF3, 0xF3, 0x30, 0x99, 0x99, 0x9F,
    0x99, 0x9F, 0x9F, 0x9F, 0x99, 0xE7, 0xF9, 0x93, 0x9F, 0x94, 0x84, 0x99,
    0x99, 0x99, 0x99, 0xCF, 0xE7, 0x99, 0x99, 0x94, 0xE7, 0x99, 0xF3, 0xCF,
    0xCF, 0xF3, 0xFF, 0xFF, 0xFF, 0xF9, 0x99, 0x99, 0x99, 0x99, 0xCF, 0x99,
    0x99, 0xE7, 0xF3, 0x99, 0xE7, 0x94, 0x99, 0x99, 0x99, 0x99, 0x91, 0x9F,
    0xCF, 0x99, 0x99, 0x94, 0x99, 0x99, 0xF9, 0xE7, 0xE7, 0xE7, 0xFF, 0x00,
    0xFF, 0xC3, 0x99, 0x80, 0x9F, 0x89, 0x93, 0xE7, 0xE7, 0xE7, 0xC9, 0xE7,
    0xFF, 0xFF, 0xFF, 0xF3, 0xC8, 0x83, 0x99, 0x99, 0xC9, 0x9F, 0xCF, 0xF3,
    0x99, 0x99, 0xE3, 0xE3, 0xE7, 0xFF, 0xE7, 0x99, 0x3C, 0x99, 0x99, 0x99,
    0x99, 0x9F, 0x9F, 0x99, 0x99, 0xE7, 0xF9, 0x93, 0x9F, 0x88, 0x8C, 0x99,
    0x99, 0x99, 0x99, 0x9F, 0xE7, 0x99, 0x99, 0x9C, 0xCB, 0x99, 0xF9, 0xCF,
    0xCF, 0xF3, 0xFF, 0xFF, 0xFF, 0xC3, 0x83, 0xC3, 0xC1, 0xC3, 0xCF, 0xC1,
    0x83, 0x87, 0xC3, 0x99, 0xE7, 0x81, 0x83, 0xC3, 0x83, 0xC1, 0x99, 0xC1,
    0x81, 0x99, 0x99, 0x9C, 0x99, 0x99, 0x81, 0xE7, 0xE7, 0xE7, 0x71, 0x00,
    0xFF, 0xC3, 0x99, 0xC9, 0x99, 0x25, 0x93, 0xE7, 0xE7, 0xE7, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xF9, 0xCC, 0xE3, 0x99, 0x99, 0xCF, 0x9F, 0xE7, 0xF9,
    0x99, 0x99, 0xFF, 0xFF, 0xF3, 0xFF, 0xCF, 0x99, 0x3C, 0xC3, 0x99, 0x99,
    0x93, 0x9F, 0x9F, 0x99, 0x99, 0xE7, 0xF9, 0x99, 0x9F, 0x9C, 0x9C, 0x99,
    0x99, 0x99, 0x99, 0x99, 0xE7, 0x99, 0x99, 0x9C, 0x99, 0x99, 0xF9, 0xCF,
    0x9F, 0xF3, 0xFF, 0xFF, 0xFF, 0xFF, 0x9F, 0xFF, 0xF9, 0xFF, 0xCF, 0xFF,
    0x9F, 0xFF, 0xFF, 0x9F, 0xE7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xCF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0xE7, 0xE7, 0x24, 0x00,
    0xFF, 0xE7, 0x99, 0xC9, 0xC3, 0x27, 0xC7, 0xE7, 0xF3, 0xCF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xF9, 0xE1, 0xF3, 0xC3, 0xC3, 0xCF, 0x81, 0xE3, 0x81,
    0xC3, 0xC3, 0xFF, 0xFF, 0xF9, 0xFF, 0x9F, 0xC3, 0x81, 0xE7, 0x83, 0xC3,
    0x87, 0x81, 0x81, 0xC3, 0x99, 0xC3, 0xF9, 0x99, 0x9F, 0x9C, 0x9C, 0xC3,
    0x83, 0xC3, 0x83, 0xC3, 0x81, 0x99, 0x99, 0x9C, 0x99, 0x99, 0x81, 0xC3,
    0x9F, 0xC3, 0x99, 0xFF, 0xF3, 0xFF, 0x9F, 0xFF, 0xF9, 0xFF, 0xE1, 0xFF,
    0x9F, 0xE7, 0xF3, 0x9F, 0x87, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xCF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF3, 0xE7, 0xCF, 0x8E, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0x8F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xC3, 0xFF, 0xE7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xE7, 0xF3, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xE7, 0xFF, 0xC7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00
};

void draw2d_draw_char_16(draw2d_rect_type* rect, int32_t pos_x, int32_t pos_y, char c, uint16_t color)
{
    if (c < 32 || c > 126)
        return;
    int32_t x0 = draw2d_clip(pos_x, rect->width);
    int32_t x1 = draw2d_clip(pos_x + 8, rect->width);
    int32_t y0 = draw2d_clip(pos_y, rect->height);
    int32_t y1 = draw2d_clip(pos_y + 16, rect->height);
    int32_t w = x1 - x0;
    int32_t h = y1 - y0;
    if (w == 0 || h == 0)
        return;
    int32_t offx = x0 - pos_x;
    int32_t offy = y0 - pos_y;
    int32_t data_col = c - 32;
    int32_t data_row = 15 - offy;
    const uint8_t* pbmp = &draw2d_font_data[data_col + 96 * data_row];
    uint16_t* prow = (uint16_t*)rect->data;
    prow = &prow[x0 + rect->stride * y0];
    while (h--)
    {
        uint8_t bmp = ~*pbmp;
        uint32_t bit = 1 << (7 - offx);
        uint16_t* p = prow;
        int32_t c = w;
        while (c--)
        {
            if (bmp & bit)
                *p = color;
            bit >>= 1;
            ++p;
        }
        pbmp -= 96;
        prow += rect->stride;
    }
}

void draw2d_draw_char_32(draw2d_rect_type* rect, int32_t pos_x, int32_t pos_y, char c, uint32_t color)
{
    if (c < 32 || c > 126)
        return;
    int32_t x0 = draw2d_clip(pos_x, rect->width);
    int32_t x1 = draw2d_clip(pos_x + 8, rect->width);
    int32_t y0 = draw2d_clip(pos_y, rect->height);
    int32_t y1 = draw2d_clip(pos_y + 16, rect->height);
    int32_t w = x1 - x0;
    int32_t h = y1 - y0;
    if (w == 0 || h == 0)
        return;
    int32_t offx = x0 - pos_x;
    int32_t offy = y0 - pos_y;
    int32_t data_col = c - 32;
    int32_t data_row = 15 - offy;
    const uint8_t* pbmp = &draw2d_font_data[data_col + 96 * data_row];
    uint32_t* prow = (uint32_t*)rect->data;
    prow = &prow[x0 + rect->stride * y0];
    while (h--)
    {
        uint8_t bmp = ~*pbmp;
        uint32_t bit = 1 << (7 - offx);
        uint32_t* p = prow;
        int32_t c = w;
        while (c--)
        {
            if (bmp & bit)
                *p = color;
            bit >>= 1;
            ++p;
        }
        pbmp -= 96;
        prow += rect->stride;
    }
}

void draw2d_draw_string_16(draw2d_rect_type* rect, int32_t pos_x, int32_t pos_y, const char* str, uint16_t color)
{
    int32_t pos_x_init = pos_x;
    while (*str)
    {
        if (*str >= 32 && *str <= 126)
        {
            draw2d_draw_char_16(rect, pos_x, pos_y, *str, color);
            pos_x += 8;
        }
        else if (*str == '\r')
        {
            pos_x = pos_x_init;
        }
        else if (*str == '\n')
        {
            pos_x = pos_x_init;
            pos_y += 16;
        }
        else
        {
            draw2d_draw_char_16(rect, pos_x, pos_y, '_', color);
            pos_x += 8;
        }
        ++str;
    }
}

void draw2d_draw_string_32(draw2d_rect_type* rect, int32_t pos_x, int32_t pos_y, const char* str, uint32_t color)
{
    int32_t pos_x_init = pos_x;
    while (*str)
    {
        if (*str >= 32 && *str <= 126)
        {
            draw2d_draw_char_32(rect, pos_x, pos_y, *str, color);
            pos_x += 8;
        }
        else if (*str == '\r')
        {
            pos_x = pos_x_init;
        }
        else if (*str == '\n')
        {
            pos_x = pos_x_init;
            pos_y += 16;
        }
        else
        {
            draw2d_draw_char_32(rect, pos_x, pos_y, '_', color);
            pos_x += 8;
        }
        ++str;
    }
}
